<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: HDSL Diagnostic</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.05.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('EXAMPLE_MOTORCONTROL_HDSL.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">HDSL Diagnostic </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1355">Introduction</a></li>
<li class="level1"><a href="#autotoc_md1356">Important files and directory structure</a></li>
<li class="level1"><a href="#autotoc_md1357">Steps to Run the Example</a><ul><li class="level2"><a href="#autotoc_md1358">Hardware Prerequisites</a></li>
<li class="level2"><a href="#autotoc_md1359">Hardware Setup(Using TIDA-00179, TIDEP-01015 and Interface board)</a></li>
<li class="level2"><a href="#autotoc_md1360">Hardware Setup(Using HDSL AM64xE1 Transceiver)</a></li>
<li class="level2"><a href="#autotoc_md1361">Build, load and run</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1362">Sync Mode:</a><ul><li class="level2"><a href="#autotoc_md1363">Synchronization with external Pulse</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1364">Sample Output</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_examples_motorcontrol_hdsl_example"></a></p>
<h1><a class="anchor" id="autotoc_md1355"></a>
Introduction</h1>
<p>The HDSL diagnostic application described here interacts with the firmware interface.</p>
<p>HDSL diagnostic application does below,</p><ul>
<li>Configures pinmux, GPIO, ICSS clock to 225MHz,</li>
<li>Initializes ICSS0-PRU1, ICSS0-IEP0 and IEP1(for SYNC mode support.Timesync router is used to latch the loopback.),</li>
<li>Loads lookup table for encoding/decoding of Hiperface data</li>
<li>Loads the initialization section of PRU firmware &amp; executes it.</li>
</ul>
<p>Firmware is split to three sections, initialization, datalink and transport. At startup, the application displays details about encoder and status. It then presents the user with menu options, based on the option selected, application communicates with HDSL interface and the result is presented to the user.</p>
<h1><a class="anchor" id="autotoc_md1356"></a>
Important files and directory structure</h1>
<table class="doxtable">
<tr>
<th>Folder/Files </th><th>Description  </th></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/examples/motor_control/hdsl_diagnostic </td></tr>
<tr>
<td>hdsl_diagnostic.c hdsl_diagnostic.h </td><td>Source and Header files   </td></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/source/motor_control/position_sense/hdsl </td></tr>
<tr>
<td>driver/ </td><td>Folder containing HDSL PRU driver sources.  </td></tr>
<tr>
<td>include/ </td><td>Folder containing HDSL PRU header sources.  </td></tr>
<tr>
<td>firmware/ </td><td><p class="starttd">Folder containing HDSL PRU firmware sources. </p>
<p class="endtd"></p>
</td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CPU + OS  </td><td class="markdownTableBodyNone">r5fss0-0 freertos   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ICSSG  </td><td class="markdownTableBodyNone">ICSSG0   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PRU  </td><td class="markdownTableBodyNone">PRU1   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Toolchain  </td><td class="markdownTableBodyNone">ti-arm-clang   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Board  </td><td class="markdownTableBodyNone">am64x-evm   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Example folder  </td><td class="markdownTableBodyNone">examples/motorcontrol/hdsl_example   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1357"></a>
Steps to Run the Example</h1>
<h2><a class="anchor" id="autotoc_md1358"></a>
Hardware Prerequisites</h2>
<p>Other than the basic EVM setup mentioned in <a class="el" href="EVM_SETUP_PAGE.html">EVM Setup</a>, below additional HW is required to run this demo</p><ul>
<li>HDSL encoder</li>
<li>Below are two options to connect encoder to AM64x/AM243x EVM.<ul>
<li><b>Option 1</b><ul>
<li>TIDA-00179 Universal Digital Interface to Absolute Position Encoders, <a href="http://www.ti.com/tool/TIDA-00179">http://www.ti.com/tool/TIDA-00179</a></li>
<li>TIDEP-01015 3 Axis board</li>
<li>Interface card connecting EVM and TIDEP-01015 3 Axis board</li>
<li>Connect the Hiperface DSL encoder to HDSL+/-(Pin number 6 and 7) signals available on header J7 or Sub-D15 connector of the "Universal Digital Interface to Absolute Position Encoders" board.</li>
</ul>
</li>
<li><b>Option 2</b><ul>
<li>HDSL AM64xE1 Transceiver. If application is using this card, define the macro HDSL_AM64xE1_TRANSCEIVER in the CCS project/make file.</li>
<li>Connect the Hiperface DSL encoder to J10.</li>
<li>HDSL AM64xE1 Transceiver supports two channels that can be used to support HDSL safety, multi axis servo drives.</li>
<li>Schematics are shared in the MCU+SDK package. For more design details of the transceiver card, please contact TI via E2E/FAE.</li>
<li><a href="../am64x_am243x/HDSL_AM64xE1_Schematics.pdf">HDSL Transceiver Card Schematics</a> document.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md1359"></a>
Hardware Setup(Using TIDA-00179, TIDEP-01015 and Interface board)</h2>
<p> <style>div.image img[src="HDSL_Connections.png"]{width:40%}</style> </p><div class="image">
<img src="HDSL_Connections.png" alt=""/>
<div class="caption">
Hardware Setup</div></div>
<h2><a class="anchor" id="autotoc_md1360"></a>
Hardware Setup(Using HDSL AM64xE1 Transceiver)</h2>
<p> <style>div.image img[src="HDSL_AM64xE1.png"]{width:60%}</style> </p><div class="image">
<img src="HDSL_AM64xE1.png" alt=""/>
<div class="caption">
Hardware Setup</div></div>
<h2><a class="anchor" id="autotoc_md1361"></a>
Build, load and run</h2>
<ul>
<li><b>When using CCS projects to build</b>, import the CCS project and build it using the CCS project menu (see <a class="el" href="CCS_PROJECTS_PAGE.html">Using SDK with CCS Projects</a>).</li>
<li><b>When using makefiles to build</b>, note the required combination and build using make command (see <a class="el" href="MAKEFILE_BUILD_PAGE.html">Using SDK with Makefiles</a>)</li>
<li>Launch a CCS debug session and run the executable, see <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a></li>
<li>Refer to UART terminal for user interface menu options.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1362"></a>
Sync Mode:</h1>
<ul>
<li>Note</li>
</ul>
<p>This is a test feature, in real application - PWM syncout will be connected to Latch input instead of IEP1 sync.</p>
<h2><a class="anchor" id="autotoc_md1363"></a>
Synchronization with external Pulse</h2>
<p>According to the Hiperface DSL specification, the falling edge inside the EXTRA window should coincide with the external synchronization pulse. At the beginning of the startup phase, the firmware measures the time interval of the external pulse and calculates the required number of bits for the H-Frame. Based on this number the stuffing length and EXTRA window size is derived. Afterwards, the PRU waits to match its timing with the timing of the external synchronization pulse and starts the transmission. Since it is possible to use time intervals for the external pulse that are not multiples of the bit duration, the firmware needs to adjust the H-Frame size on the fly. Furthermore, during the EXTRA window the PRU transmits the data (sample edge) with a granularity of 13.3ns to increase the synchronization accuracy. Figure "Synchronization of External Pulse with Sample Edge in EXTRA Window" and "Illustration of Synchronization Algorithm" depict the concept. The EXTRA_TIME_WINDOW is a fixed value that is calculated at startup to match the external pulse frequency. The TIME_REST value gives the number of overclocked ‘1’ that needs to be sent during the last bit of the EXTRA window.</p>
<p> <style>div.image img[src="hdsl_external_sync.png"]{width:40%}</style> </p><div class="image">
<img src="hdsl_external_sync.png" alt=""/>
<div class="caption">
Synchronization of External Pulse with Sample Edge in EXTRA Window</div></div>
<p>In other words, the TIME_REST value represents the sample edge in a fine granularity dimension (13.3ns). While the sample edge can be send with a finer granularity, the granularity of the size of the EXTRA window is still in whole bit durations (106.67ns). Consequently, there is an overhead, if the external pulse period is not a multiple of the bit duration. This overhead is compensated in the next H-Frame by changing the size of the EXTRA window. As a result, the size of the H-Frame is varying over time. It is possible that these calculations lead to the excess of the maximum or minimum EXTRA window size. Therefore, the number of bits for the stuffing and EXTRA window is readjusted on a violation.</p>
<p> <style>div.image img[src="hdsl_sync_algo.png"]{width:40%}</style> </p><div class="image">
<img src="hdsl_sync_algo.png" alt=""/>
<div class="caption">
Illustration of Synchronization Algorithm</div></div>
<p>The algorithm is given as C code in the following: </p><pre class="fragment">        /* EXTRA_SIZE equals the number of bits for the EXTRA window minus 1 */
        if(EXTRA_EDGE == 0)
            TIME_REST += 8;
        short b = (EXTRA_SIZE &lt;&lt; 3) + TIME_REST;
        short overhead = (EXTRA_SIZE &lt;&lt; 3) + 8 - TIME_EXTRA_WINDOW;
        EXTRA_SIZE = (b - overhead) &gt;&gt; 3;
        TIME_REST = (b - overhead) - (EXTRA_SIZE &lt;&lt; 3);

        if(EXTRA_SIZE &lt; 3) {
            EXTRA_SIZE += 6;
            NUM_STUFFING -= 1;
            TIME_EXTRA_WINDOW += (8*6);
        }
</pre><p> if(EXTRA_SIZE &gt; 8) { EXTRA_SIZE -= 6; NUM_STUFFING += 1; TIME_EXTRA_WINDOW -= (8*6); }</p>
<p>EXTRA_EDGE represents the TIME_REST value in a format that can be pushed to the TX FIFO for transmission. For instance, if TIME_REST is 4, EXTRA_EDGE is 0xf0. The edge would be in the middle of the bit duration. The value NUM_STUFFING gives the number of stuffing blocks (each block consist of 6 bits).</p>
<p>For further improvement of the synchronization, the time difference (∆t) between the external pulse and the sample edge we transmit is measured (Figure "Time difference between External Pulse and Sample Edge").</p>
<p> <style>div.image img[src="hdsl_external_sync_sample_edge.png"]{width:40%}</style> </p><div class="image">
<img src="hdsl_external_sync_sample_edge.png" alt=""/>
<div class="caption">
Time difference between External Pulse and Sample Edge</div></div>
<h1><a class="anchor" id="autotoc_md1364"></a>
Sample Output</h1>
<p>Shown below is a sample output when the application is run:</p>
<ul>
<li>Freerun mode:  <style>div.image img[src="hdsl_default_uart_menu.PNG"]{width:60%}</style> <div class="image">
<img src="hdsl_default_uart_menu.PNG" alt=""/>
<div class="caption">
HDSL DDR UART Default Menu</div></div>
</li>
<li>Sync Mode:  <style>div.image img[src="HDSL_SYNC.png"]{width:60%}</style> <div class="image">
<img src="HDSL_SYNC.png" alt=""/>
<div class="caption">
HDSL Diagnostic in SYNC mode</div></div>
 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
