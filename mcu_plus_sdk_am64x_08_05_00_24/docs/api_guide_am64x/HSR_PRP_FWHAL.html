<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: HSR_PRP(High-availability seamless Redundancy/Parallel Redundancy Protocol) FWHAL</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.05.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('HSR_PRP_FWHAL.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">HSR_PRP(High-availability seamless Redundancy/Parallel Redundancy Protocol) FWHAL </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md956">Introduction</a></li>
<li class="level1"><a href="#autotoc_md957">Data Sheet</a><ul><li class="level2"><a href="#autotoc_md958">Features Supported</a></li>
<li class="level2"><a href="#autotoc_md959">Known Issues</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md960">Important Files and Directory Structure</a></li>
<li class="level1"><a href="#autotoc_md961">Terms and Abbreviations</a></li>
<li class="level1"><a href="#autotoc_md962">API Documentation</a></li>
<li class="level1"><a href="#autotoc_md963">Procedure to kick-off the PRP</a></li>
<li class="level1"><a href="#autotoc_md964">Integration with ICSS-EMAC</a><ul><li class="level2"><a href="#autotoc_md965">Interface with ICSS-EMAC</a></li>
<li class="level2"><a href="#autotoc_md966">Callbacks from ICSS EMAC</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md967">Interrupts</a><ul><li class="level2"><a href="#autotoc_md968">Tasks</a></li>
<li class="level2"><a href="#autotoc_md969">Semaphores</a></li>
<li class="level2"><a href="#autotoc_md970">Clocks</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md971">See also</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_components_industrial_comms_hsr_prp"></a></p>
<h1><a class="anchor" id="autotoc_md956"></a>
Introduction</h1>
<p>This software is designed for the TI SoCs with PRU-ICSS IP to enable customers add HSR/PRP(High-availability seamless Redundancy and Parallel Redundancy Protocol) Dual Attached Node support to their system. It implements HSR/PRP functionality and provides HSR/PRP FPGA like functionality integrated into TI SoCs.</p>
<p>HSR and PRP are Ethernet based communication technology commonly deployed in smart grid substation for low cost, easy to maintain and interoperable common network infrastructure with built-in redundancy. They exist as a LRE(Link Redundancy Entity) between the MAC and Network layer above providing a transparent view of the MAC below to the application. Every packet is duplicated by the HSR/PRP FWHAL on it's way out and only a single copy of the duplicates arriving is forwarded to Host.</p>
<div class="image">
<img src="HSR_PRP_Software_Architecture.png" alt=""/>
<div class="caption">
Software Architecture</div></div>
<p>HSR/PRP firmware for PRU-ICSS is a black box product maintained by TI. HSR/PRP FWHAL(Firmware and Hardware Abstraction Layer) allows loading and running HSR/PRP firmware and acts as an interface with the firmware. Firmware is based on 200 MHz clock frequency for PRU-ICSS Core Clock and IEP Clock.</p>
<h1><a class="anchor" id="autotoc_md957"></a>
Data Sheet</h1>
<h2><a class="anchor" id="autotoc_md958"></a>
Features Supported</h2>
<table class="doxtable">
<tr>
<th>Feature </th><th>Description </th><th>Implementation  </th></tr>
<tr>
<td>High-Availability Seamless (HSR as per clause 5 of IEC 62439) </td><td>Redundancy Operates as a DANH, Support for modes – H, T, U and N as per standard, Two ports as per standard(Port A &amp; Port B), Modes can be changed at runtime </td><td>Yes  </td></tr>
<tr>
<td>Parallel Redundancy Protocol (PRP as per clause 4 of IEC 62439) </td><td>Operates as DANP, Two ports as per standard(Port A &amp; Port B) </td><td>Yes  </td></tr>
<tr>
<td>Quality of Service (QoS) </td><td>Two priority receive queues on host port(6 KB), Four priority transmit queues on each physical port(3 KB). </td><td>Yes  </td></tr>
<tr>
<td>Node Table </td><td>256 entries, Hash Table for faster lookup(Complexity : O(1)), Node forget time : 60s, Node Table statistics </td><td>Yes  </td></tr>
<tr>
<td>Multicast Filtering </td><td>Support for Multicast Packet Filtering, Hash Table for faster lookup(Complexity : O(1)) </td><td>Yes  </td></tr>
<tr>
<td>VLAN Filtering </td><td>Support for VLAN Filtering for host port, Hash Table for faster lookup(Complexity : O(1)) </td><td>Yes  </td></tr>
<tr>
<td>Duplicate Discard Table </td><td>Duplicate discard on Port to Host path (PRP), Data integrity (CRC) check during port to port forwarding </td><td>Yes  </td></tr>
<tr>
<td rowspan="2">Duplex </td><td>Full </td><td>Yes  </td></tr>
<tr>
<td>Half </td><td>No  </td></tr>
<tr>
<td rowspan="3">Speed </td><td>Auto </td><td>Yes  </td></tr>
<tr>
<td>10Mbps </td><td>No  </td></tr>
<tr>
<td>100Mbps </td><td>Yes  </td></tr>
<tr>
<td>Statistics </td><td>Supports all MIB statistics as per standard, Node Table statistics for debugging, Self-configuring </td><td>Yes  </td></tr>
<tr>
<td>PTP/1588 – Time Synchronization </td><td>PTP, Supports P2P clock, PTP over 802.3 (Annex F), Transparent Clock supported, Ordinary Clock supported, Single and Two step clock supported, Peer delay Response is always sent as two-step </td><td>Yes  </td></tr>
<tr>
<td>Port Buffering </td><td>1 ms buffering per port </td><td>Yes  </td></tr>
<tr>
<td>Storm Prevention </td><td>Multicast and Broadcast storm prevention per port </td><td>Yes  </td></tr>
<tr>
<td>Interrupt for Link loss detection </td><td>Link loss detection, Callback APIs to perform tasks related to change in network topology </td><td>Yes  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md959"></a>
Known Issues</h2>
<table class="doxtable">
<tr>
<th>Record ID </th><th>Details </th><th>Workaround  </th></tr>
<tr>
<td>PINDSW-5290 </td><td>Frame drops due to LWIP pool reduction </td><td><p class="starttd"></p>
<p class="intertd">Add following code in source/networking/lwip/lwip-config/am64x/lwippools.h file : LWIP_MALLOC_MEMPOOL(100, 256) LWIP_MALLOC_MEMPOOL(50, 512) LWIP_MALLOC_MEMPOOL(50, 1024) LWIP_MALLOC_MEMPOOL(50, 1792).</p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>MCUSDK-4379 </td><td>Low Tx side throughput seen when tested using iperf application </td><td><p class="starttd"></p>
<p class="intertd">Replace mcu_plus_sdk\source\networking\lwip\lwip-config\am64x\lwipopts.h and mcu_plus_sdk\source\networking\lwip\lwip-config\am64x\lwippools.h from MCU PLUS SDK 8.2.0 release and rebuild lwip_freertos, lwip-contrib and icss_emac_lwip_if libraries.</p>
<p class="endtd"></p>
</td></tr>
<tr>
<th>MCUSDK-8234 </th><th>HSR/PRP - PTP Device is unable to keep offset under 1000 ns </th><th>-  </th></tr>
<tr>
<th>MCUSDK-8236 </th><th>HSR/PRP is not functional in rgmii mode </th><th>-  </th></tr>
</table>
<h1><a class="anchor" id="autotoc_md960"></a>
Important Files and Directory Structure</h1>
<table class="doxtable">
<tr>
<th>Folder/Files </th><th>Description  </th></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/examples/industrial_comms </td></tr>
<tr>
<td>hsr_prp_demo </td><td>HSR/PRP Examples (based on pre-integrated stack)  </td></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/source/industrial_comms/hsr_prp </td></tr>
<tr>
<td>icss_fwhal/firmware </td><td>Firmware for the PRU cores in PRU-ICSS. <b>Firmware Version : 2.20.31</b>   </td></tr>
<tr>
<td>icss_fwhal/lib/ </td><td>FWHAL library for HSR/PRP  </td></tr>
<tr>
<td>icss_fwhal/*.c </td><td>FWHAL source files  </td></tr>
<tr>
<td>icss_fwhal/*.h </td><td>FWHAL interface files  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md961"></a>
Terms and Abbreviations</h1>
<table class="doxtable">
<tr>
<th>Abbreviation </th><th>Expansion  </th></tr>
<tr>
<td>PRU-ICSS </td><td>Programmable Real-Time Unit Industrial Communication Subsystem  </td></tr>
<tr>
<td>HSR </td><td>High-availability seamless Redundancy Protocol (A redundancy protocol)  </td></tr>
<tr>
<td>DANH </td><td>Dual Attached Node (HSR)  </td></tr>
<tr>
<td>PRP </td><td>Parallel Redundancy Protocol (A redundancy protocol)  </td></tr>
<tr>
<td>DANP </td><td>Dual Attached Node (PRP)  </td></tr>
<tr>
<td>LRE </td><td>Link Redundancy Entity  </td></tr>
<tr>
<td>MII </td><td>Media Independent Interface  </td></tr>
<tr>
<td>DL </td><td>Datalink Layer  </td></tr>
<tr>
<td>PTP-1588 </td><td>Precision Time Protocol (IEEE time synchronization protocol)  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md962"></a>
API Documentation</h1>
<p>Please see <a class="el" href="group__INDUSTRIAL__COMMS__HSR__PRP__FWHAL__MODULE.html">APIs for HSR/PRP FWHAL</a> for API documentation.</p>
<h1><a class="anchor" id="autotoc_md963"></a>
Procedure to kick-off the PRP</h1>
<ul>
<li>Initialize ICSS-EMAC to work as a switch</li>
<li>Initialize the required tasks and interrupts</li>
<li>Initialize the HSR/PRP FWHAL and PRU-ICSS INTC</li>
<li>Load HSR/PRP firmware into PRUs of PRU-ICSS</li>
<li>Start firmware</li>
<li>Handle the events as needed.</li>
</ul>
<h1><a class="anchor" id="autotoc_md964"></a>
Integration with ICSS-EMAC</h1>
<p>TI HSR/PRP solution uses the ICSS-EMAC as it's base switch layer. The PRU Firmware is customized for HSR/PRP functionalities, and is not same as a standard switch firmware. All the traffic to Host is handled by HSR/PRP LRE (Link redundancy entity). The NRT(non-real time) traffic is passed to the LwIP stack while the Real time traffic goes to the registered callback.</p>
<h2><a class="anchor" id="autotoc_md965"></a>
Interface with ICSS-EMAC</h2>
<p>HSR/PRP packets are standard ethernet frames and all protocol specific data is embedded in TCP/IP payload. On a standard ICSS-EMAC Switch driver, of the 4 queues, two queues are dedicated to each receiving port, that is packet from <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga58baf4f1ee5d93fe30767c932284c018">ICSS_EMAC_QUEUE1</a>, <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga37efc82fa7a7db969ac8f602b2ec779a">ICSS_EMAC_QUEUE3</a> go to RT callback and packets from <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga0c21f82b0c954e3cb36519c9f521b780">ICSS_EMAC_QUEUE2</a>, <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga5b6a99a438eb9bfde971daa0cdbfc045">ICSS_EMAC_QUEUE4</a> go to NRT callback. We need to set "RT/NRT Priority Separation Queue" to (QUEUE 2) in SysConfig for ICSS-EMAC.</p>
<p>The packets are forwarded to based on the priority of the packet which is decided by the queue number (refer to <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_QOS">Quality of Service and Queues</a>). The driver decides to forward high priority packets to the <code>rxRTCallBack</code> and the rest are forwarded to LwIP stack, done by <code>rxNRTCallBack</code>.</p>
<h2><a class="anchor" id="autotoc_md966"></a>
Callbacks from ICSS EMAC</h2>
<p>HSR/PRP FWHAL provides custom Rx and Tx functions to be used for HSR/PRP application. This needs to be configured while initializing ICSS EMAC driver. The custom Rx and Tx functions override the default Rx and Tx functions (<a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga6a5967f060e14a11d20eea9cd8b66e5f">ICSS_EMAC_rxPktGet</a> and <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga49a2a061f6f24145004053b005f6e1a5">ICSS_EMAC_txPacket</a> respectively) provided by ICSS-EMAC driver.</p>
<table class="doxtable">
<tr>
<th>Callback Name </th><th>Description </th><th>Function used for callback registration  </th></tr>
<tr>
<td>Custom Rx </td><td>The callback handles the PRP trailer present it in the message and removes it for the upper layers, presenting a transparent interface. </td><td><a class="el" href="group__COMMON__API.html#ga9d305ea95a579f91ab10cd7d83d2c3ac">RedRxPktGet</a>  </td></tr>
<tr>
<td>Custom Tx </td><td>The callback inserts the redundancy tags in the frame, duplicates packets on both ports and attempts to send them out at the same time. </td><td><a class="el" href="group__COMMON__API.html#gabd0d6c4b69fd530591863f24527de4f5">RedTxPacket</a>  </td></tr>
<tr>
<td>Rx RT </td><td>This callback is used for processing high priority packets like PTP. It is implemented in the application itself as an example. </td><td><code>hsrprp_processHighPrioFrames</code>  </td></tr>
<tr>
<td>Rx NRT </td><td>This callback is used to send all the non real-time packets to lwIP stack. </td><td><code>Lwip2Emac_serviceRx</code>  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md967"></a>
Interrupts</h1>
<p>HSR/PRP firmware generates the following interrupts.</p>
<p>HSR/PRP implementation uses following interrupts mapped to Host Interrupt Controller. 8 Host Interrupts (Host Interrupts 2 through 9) are exported from the PRU_ICSSG internal INTC for signaling the device level interrupt controllers. PRU_EVTOUT0 to PRU_EVTOUT7 correspond to these eight interrupts in the following table. Please check <a class="el" href="DRIVERS_PRUICSS_PAGE.html#PRUICSS_INTC">PRUICSS Interrupt Controller</a> section for more details.</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Host Interrupt </th><th>Description  </th></tr>
<tr>
<td>Frame Receive </td><td>PRU_ICSS_EVTOUT0 </td><td>Notifies host when firmware has stored a frame in host receive queue  </td></tr>
<tr>
<td>Tx Callback Interrupt </td><td>PRU_ICSS_EVTOUT3 </td><td>Raised when a PTP/1588 frame which requires Tx Timestamping is sent out  </td></tr>
<tr>
<td>Link Status </td><td>PRU_ICSS_EVTOUT6 </td><td>Interrupt is raised when the Link on MII0/MII1 port comes up or goes down  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md968"></a>
Tasks</h2>
<p>The HSR/PRP FWHAL uses following tasks</p>
<ul>
<li><code>RedLifeCheckTask</code> : Check for Link up, prepare a supervision frame and then send them periodically. This is done by waiting on a semaphore redLifeCheckSemaphore which is in turn posted by a Timer. The task initialization is done inside <a class="el" href="group__COMMON__API.html#ga66d8a0367d75143939efb6beadb0c3e1">RedLifeCheckTaskCreate</a>.</li>
<li><code>RedNodetableRefresh</code> : Increments the <code>timeLastSeenX</code> values by 1 every 10 ms and delete a node table entry if it reaches <code>NODE_FORGET_TIME</code>. The task initialization is done inside <a class="el" href="group__COMMON__API.html#ga66d8a0367d75143939efb6beadb0c3e1">RedLifeCheckTaskCreate</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md969"></a>
Semaphores</h2>
<p>The HSR/PRP FWHAL uses following semaphores</p>
<ul>
<li>redLifeCheckSemaphore : redLifeCheckSemaphore to gate the sending of supervision frames. A timer interrupt upon expiry posts the semaphore thus enabling periodic transmission of supervision frames.Semaphore created in <a class="el" href="group__COMMON__API.html#ga66d8a0367d75143939efb6beadb0c3e1">RedLifeCheckTaskCreate</a>.</li>
<li>nodesTableSemaphore : nodesTableSemaphore to gate the increments of <code>timeLastSeenX</code> values by 1 every 10 ms and delete a node table entry if it reaches <code>NODE_FORGET_TIME</code>. Semaphore created in <a class="el" href="group__COMMON__API.html#ga66d8a0367d75143939efb6beadb0c3e1">RedLifeCheckTaskCreate</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md970"></a>
Clocks</h2>
<p>The HSR/PRP FWHAL uses following clocks</p>
<ul>
<li>redPruCheckTimer : This timer is used to periodically check and clear bits in Firmware implementation. ISR is <code>RedPruCheckTimerHandler</code>. Period is specified by <code>RED_PRU_CHECK_TIMER_PERIOD</code> (microseconds).</li>
<li>redLifeCheckTimer : This timer is used to send supervision frames periodically. ISR is <code>RedLifeCheckTimerHandler</code> where it posts a semaphore redLifeCheckSemaphore to indicate to a waiting task to send supervision frames. Period is specified by <code>RED_LIFE_CHECK_TIMER_PERIOD</code> (microseconds).</li>
</ul>
<h1><a class="anchor" id="autotoc_md971"></a>
See also</h1>
<ul>
<li><a class="el" href="EXAMPLES_INDUSTRIAL_COMMS_HSR_PRP_DEMOS.html">HSR/PRP Demo</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
