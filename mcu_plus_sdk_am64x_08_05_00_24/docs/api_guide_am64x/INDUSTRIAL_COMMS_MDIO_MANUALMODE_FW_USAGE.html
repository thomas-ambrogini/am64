<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: PRU-ICSS Firmware for MDIO Manual Mode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.05.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('INDUSTRIAL_COMMS_MDIO_MANUALMODE_FW_USAGE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PRU-ICSS Firmware for MDIO Manual Mode </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_components_industrial_comms_mdio_manual_mode_fw"></a> </p>
<h1><a class="anchor" id="autotoc_md972"></a>
Hardware Issue</h1>
<p>If your silicon is affected with errata <a href="https://www.ti.com/lit/er/sprz457e/sprz457e.pdf" target="_blank">i2329â€” MDIO interface corruption</a>, then TI suggests to use MDIO Manual mode as software workaround mentioned below.</p>
<h1><a class="anchor" id="autotoc_md973"></a>
Working of PRU-ICSS Firmware for MDIO Manual Mode</h1>
<ul>
<li>Firmware Flow<ul>
<li>The firmware, by configuring the MDIO Control Register, enables the MDIO state machine once for some period (less than 1us) and then disables it.</li>
<li>Then it configures the MDIO hardware in 'MDIO_MODE_MANUAL' and keeps the MDIO internal state machine disabled.</li>
<li>Now the firmware uses the new defined register space to emulate the actual MDIO register space.</li>
<li>It configures the MDIO hardware by copying over the register values from this defined register space to the actual MDIO addresses.</li>
<li>The firmware runs in a loop, and checks if there are any PHY access requests by reading the <code>GO</code> bit of the user-access registers.</li>
<li>If there is some PHY access request, then it performs the operation and clears the <code>GO</code> bit of the user-access register.</li>
<li>The firmware manually drives the MDIO_DATA and MDIO_CLK pins using MANUAL_IF_REG registers of MDIO to execute the PHY operations (in clause22 mode only). The MDIO_CLK frequency is fixed around 2.5MHz.</li>
</ul>
</li>
<li>Other cores can use the user-access registers to perform PHY accesses, because both MDIO_USER_ACCESS_REG_0 and MDIO_USER_ACCESS_REG_1 are implemented.</li>
<li>The register address has to be passed to the firmware by setting the R12 register of PRU to the desired location for emulating the MDIO register space.<ul>
<li>For example, if we set R12 to 0x00010000 (ICSSG shared memory offset) for ICSSG1 instance, the MDIO registers will start from 0x30090000 and so the user access registers' offsets will be (0x30090000+0x80) for USER_ACCESS_0_REG and (0x30090000+0x88) for USER_ACCESS_1_REG.</li>
</ul>
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Each protocol will have different base register offset depending on the availability of free memory region.</dd></dl>
<h1><a class="anchor" id="autotoc_md974"></a>
Example Usage</h1>
<p>This section describes how to use the manual-mode firmware to make PHY register accesses.</p>
<h2><a class="anchor" id="autotoc_md975"></a>
Sysconfig</h2>
<p>Enable the manual mode option from SysConfig from the protocol specific module. Enabling this updates the MDIO base address which will be used by the ETHPHY driver.</p>
<p> <style>div.image img[src="MDIO_manual_mode.PNG"]{width:60%}</style> </p><div class="image">
<img src="MDIO_manual_mode.PNG" alt=""/>
</div>
<h2><a class="anchor" id="autotoc_md976"></a>
Load PRU firmware</h2>
<p>Order to follow for loading MDIO Manual MDIO firmware:</p><ul>
<li>Make sure any MDIO access is made only after the firmware has been loaded.</li>
<li>Clear the register space which will be used by firmware for MDIO register space emulation.</li>
<li>Load the PRU firmware and set the R12 register to the emulated MDIO base register offset.</li>
<li>Enable the PRU core and then we can create MDIO User Access Register requests.</li>
</ul>
<p>Check the function <code>tiesc_mdioManualModeSetup()</code> in <code>tiescsoc.c</code> at location <code>${SDK_INSTALL_PATH}/examples/industrial_comms/ethercat_slave_beckhoff_ssc_demo/am64x-evm/tiescsoc.c</code> for understanding how to load and run the PRU firmware.</p>
<p>The PRU firmware can be built using the example present at <code>${SDK_INSTALL_PATH}/examples/pru_io/mdio_fw</code>.</p>
<p> <style>div.image img[src="Industrial_protocols_cores_usage.png"]{width:60%}</style> </p><div class="image">
<img src="Industrial_protocols_cores_usage.png" alt=""/>
</div>
<p>By default the MDIO manual mode firmware is loaded on TX_PRU core, but we can load the same firmare on other unused RTU_PRU or TX_PRU cores if needed.</p>
<h2><a class="anchor" id="autotoc_md977"></a>
Using User Access Registers</h2>
<p>Creating PHY access requests from the R5F core remains same as all the configuration settings (for changing the MDIO base address) are modified by SysConfig. There is no change in the MDIO driver APIs, only the base address has to change for the API calls.</p>
<h1><a class="anchor" id="autotoc_md978"></a>
Impact</h1>
<ul>
<li>One PRU is now reserved for emulating MDIO Manual Mode functionality.</li>
<li>For MDIO API Usage, the base address is now changed. <a class="el" href="group__DRV__MDIO__MODULE.html#ga4fa82fb47226414567b3f803b0fdf5a0">MDIO_initClock</a> API call is not needed.</li>
<li>Following Registers are not available when using MDIO manual mode firmware (from the emulated register space):<ul>
<li>MDIO_VERSION_REG (MDIO Version Register)</li>
<li>MDIO_CONTROL_REG (MDIO Control Register)</li>
<li>MDIO_ALIVE_REG (MDIO Alive Register)</li>
<li>MDIO_LINK_INT_RAW_REG (MDIO Link Interrupt Raw Register)</li>
<li>MDIO_LINK_INT_MASKED_REG (MDIO Link Interrupt Masked Register)</li>
<li>MDIO_LINK_INT_MASK_SET_REG (MDIO Link Interrupt Mask Set Register)</li>
<li>MDIO_LINK_INT_MASK_CLEAR_REG (MDIO Link Interrupt Mask Clear Register)</li>
<li>MDIO_USER_INT_RAW_REG (MDIO User Interrupt Raw Register)</li>
<li>MDIO_USER_INT_MASKED_REG (MDIO User Interrupt Masked Register)</li>
<li>MDIO_USER_INT_MASK_SET_REG (MDIO User Interrupt Mask Set Register)</li>
<li>MDIO_USER_INT_MASK_CLEAR_REG (MDIO User Interrupt Mask Clear Register)</li>
<li>MDIO_MANUAL_IF_REG (MDIO Manual Interface Register)</li>
<li>MDIO_POLL_REG (MDIO Poll Inter Register)</li>
<li>MDIO_POLL_EN_REG (MDIO Poll Enable Register)</li>
<li>MDIO_CLAUS45_REG (Clause 45 Register)</li>
<li>MDIO_USER_ADDR0_REG (MDIO User Address 0 Register)</li>
<li>MDIO_USER_ADDR1_REG (MDIO User Address 1 Register)</li>
</ul>
</li>
<li>Only following registers are available when using MDIO manual mode firmware (from the emulated register space):<ul>
<li>MDIO_LINK_REG (MDIO Link Register)</li>
<li>MDIO_USER_ACCESS_REG_0 (MDIO User Access 0 Register)</li>
<li>MDIO_USER_PHY_SEL_REG_0 (MDIO User PHY Select 0 Register)</li>
<li>MDIO_USER_ACCESS_REG_1 (MDIO User Access 1 Register)</li>
<li>MDIO_USER_PHY_SEL_REG_1 (MDIO User PHY Select 1 Register)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md979"></a>
Constraints and Limitations</h1>
<ul>
<li>MLINK pin is necessary for MDIO_LINK_REG updates. We need MLINK feature of MDIO to do automatic polling of link status via the MIIx_RXLINK input pin to PRU-ICSS which must be connected to a status output from the external PHY which does not toggle while the link is active.</li>
<li>The firmware does not support polling based MDIO Link Register update.</li>
<li>Only Clause 22 frame format is supported. Clause 45 frame format is not supported.</li>
<li>MDIO state machine is disabled and hence MDIO LINK_INT and USER_INT interrupts are NOT available.</li>
</ul>
<h1><a class="anchor" id="autotoc_md980"></a>
Important files and directory structure</h1>
<table class="doxtable">
<tr>
<th>Folder/Files </th><th>Description  </th></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/examples/pru_io/ </td></tr>
<tr>
<td>mdio_fw/ </td><td>Contains the project files needed for MDIO manual mode firmware   </td></tr>
<tr>
<td colspan="2" bgcolor="#F0F0F0">${SDK_INSTALL_PATH}/source/pru_io/ </td></tr>
<tr>
<td>firmware/common/mdio_macros.inc </td><td>Contains the source file needed for MDIO manual mode firmware   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
